'use strict';
const {constants: BufferConstants} = require('buffer');
<<<<<<< HEAD
const pump = require('pump');
const bufferStream = require('./buffer-stream');

=======
const stream = require('stream');
const {promisify} = require('util');
const bufferStream = require('./buffer-stream');

const streamPipelinePromisified = promisify(stream.pipeline);

>>>>>>> fdb7c92a283e1067c995a5190717b93d6197f83d
class MaxBufferError extends Error {
	constructor() {
		super('maxBuffer exceeded');
		this.name = 'MaxBufferError';
	}
}

async function getStream(inputStream, options) {
	if (!inputStream) {
<<<<<<< HEAD
		return Promise.reject(new Error('Expected a stream'));
=======
		throw new Error('Expected a stream');
>>>>>>> fdb7c92a283e1067c995a5190717b93d6197f83d
	}

	options = {
		maxBuffer: Infinity,
		...options
	};

	const {maxBuffer} = options;
<<<<<<< HEAD

	let stream;
=======
	const stream = bufferStream(options);

>>>>>>> fdb7c92a283e1067c995a5190717b93d6197f83d
	await new Promise((resolve, reject) => {
		const rejectPromise = error => {
			// Don't retrieve an oversized buffer.
			if (error && stream.getBufferedLength() <= BufferConstants.MAX_LENGTH) {
				error.bufferedData = stream.getBufferedValue();
			}

			reject(error);
		};

<<<<<<< HEAD
		stream = pump(inputStream, bufferStream(options), error => {
			if (error) {
				rejectPromise(error);
				return;
			}

			resolve();
		});
=======
		(async () => {
			try {
				await streamPipelinePromisified(inputStream, stream);
				resolve();
			} catch (error) {
				rejectPromise(error);
			}
		})();
>>>>>>> fdb7c92a283e1067c995a5190717b93d6197f83d

		stream.on('data', () => {
			if (stream.getBufferedLength() > maxBuffer) {
				rejectPromise(new MaxBufferError());
			}
		});
	});

	return stream.getBufferedValue();
}

module.exports = getStream;
<<<<<<< HEAD
// TODO: Remove this for the next major release
module.exports.default = getStream;
=======
>>>>>>> fdb7c92a283e1067c995a5190717b93d6197f83d
module.exports.buffer = (stream, options) => getStream(stream, {...options, encoding: 'buffer'});
module.exports.array = (stream, options) => getStream(stream, {...options, array: true});
module.exports.MaxBufferError = MaxBufferError;
